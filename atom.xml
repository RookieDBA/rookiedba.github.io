<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[RookieDBA]]></title>
  <link href="http://RookieDBA.github.io/atom.xml" rel="self"/>
  <link href="http://RookieDBA.github.io/"/>
  <updated>2014-08-22T01:28:18+08:00</updated>
  <id>http://RookieDBA.github.io/</id>
  <author>
    <name><![CDATA[RookieDBA]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[2013中国数据库技术大会（DTCC）见闻]]></title>
    <link href="http://RookieDBA.github.io/blog/2014/08/22/2013-dtcc/"/>
    <updated>2014-08-22T01:24:15+08:00</updated>
    <id>http://RookieDBA.github.io/blog/2014/08/22/2013-dtcc</id>
    <content type="html"><![CDATA[<p>很荣幸有幸参加2013的DTCC，这里高手云集，汇聚了中国DB界的泰山北斗，他们给大家分享自己的学术见解，分享心得，以及学习之道。并且通过DTCC，相互交流，可以了解业界各公司在做些什么事情，有什么样的技术可以应用在适合的场景下，从而学习一些思路。</p>

<p>由于工作上的一些原因，大会第一天的议程没有参加，比较遗憾，而第一天的议程中，本人比较感兴趣的主题，是来自支付宝的童家旺先生的CAP理论，腾讯雷林海先生的高一致性数据层解决方案，以及大数据的议题。在系统设计中，对于有高一致性要求的系统架构，往往很难去达到很好的系统扩展以及高可用，所以想了解一下别人眼中对这样一类系统的设计见解。庆幸的是本人还是有机会向童家旺先生请教交流的。而最近很多人都在谈论大数据，也想了解一下不同人眼中的大数据，以及他们的理解与想法，开拓一下见识。</p>

<p>印象最深的是恩墨学院的侯圣文先生的主持与演讲，只能说，不愧是做培训的，侯圣文演讲的语调与方式，让人容易接受他所传授的知识，《DBA成长之路》这个话题中，恩墨科技的李轶楠、侯圣文、杨廷琨、张乐亦给我们分享了一个案例，给人的感觉就是在解决故障时，考研的是DBA平时的知识积累以及学习的深度。个人感觉，在平时工作中，很容易被工作内容所绑架和忽略了深入学习，而往往缺少深入学习而就成为成长的瓶颈。侯圣文先生说了一个现象，往往遇到故障的时候，随着故障时间的上升每隔5分钟，操作手的背后就会多站一个领导，而且领导的level也会每隔5分钟逐级递增，往往给操作人员带来压力。然而，我想分享的一点，是我的老板传授的一点，或许更适合甲方，那就是面对应急的时候，首先要做的事情是恢复业务，其次才是分析问题产生的原因与后续的优化，而且应急处理的流程应该是在事先准备好的，当故障发生后，可以快速的恢复业务系统。</p>

<p>从eygle大师盖国强先生、中航信的崔华先生给我们分享的内容中，了解到经验的积累的多么的重要。多年的工作会遇到各种大大小小的case，而每个case，都是增长经验增长知识的机会，应该要善于积累、沉淀下来。eygle告诉我们，他现在留着从他工作以来所遇到的大部分案例的原始资料，并且通过自己的总结、沉淀成为了自己的知识与经验。在这一块上，很是值得我去学习，尤其是我刚从事DBA相关工作不久，经验不足。曾经也学习过以及遇到过一些大小不一的案例，不总结沉淀很容易就疏漏遗忘。</p>

<!-- more -->


<p>白鳝大师徐戟先生所分享的内容，也是DBA的成长相关，很可惜因为赶飞机的缘故听了一半的内容就离开了会场。白鳝大师归纳了几类DBA的分类，以及不同分类的一些发展方向。套在自己身上，似乎觉得本人目前从事着开发DBA的工作，也兼顾着一些系统DBA的内容，也有那么一点混合型的意思。当然在这一点上，本人自己目前并没有想清楚自己更愿意往哪条路上去发展，但至少从面上去学习与发展，对各个方向都有所理解后，才能坚定自己的方向。</p>

<p>有一点，其实觉得DTCC这样，每一场报告都听其实也是不必要且比较不明智的（抱歉，我并没有对演讲者表示不禁）。自己听下来以后的一些见解是，听自己感兴趣的话题会特别来精神，而一些自己兴趣不是那么浓厚的，就很可能听不进去。</p>

<p>还有一点，本次大会主场部分，比较多的公司在介绍自己的产品。或许是因为目前本人的见识还比较浅，还比较局限于那么一两种技术中，所以觉得对这些介绍自己产品的topic比较不敢兴趣，其一是因为介绍产品并没有将它的设计思路share出来（当然这一般也不会被share出来），其二是它演讲中有一些推广产品的意思在那里。所以对我个人而言，比较感兴趣的专场是Oracle专场和DBA成长。对于一个DBA来说，局限于某几种技术确实不太好，但我觉得对于目前的我来说，专注的把一两种技术玩转是当下的一个目标，如果在职业发展前期就百花齐放，也许对自己的成长不利。</p>

<p>总的来说，这一趟不虚此行，听了几位大师分享的一些案例，稍微也会自己做一些实验重现后消化为自己的经验，也借鉴大师们的学习方法与习惯，养成自己的职业素养。去年下半年的KPI中的一项是养成良好的职业素养，这一块在今年要更加落实。做DBA的，稳重、靠谱才是别人信任的前提，在此基础上，去学习，多动手多总结，看书不实践很难将知识真正掌握。非常感谢主管李颖赟先生、童家旺先生提供的此次DTCC的机会，同样也感谢支付宝DBA团队的同学们帮我分担工作上的事情让我能参加此次大会，不敢说对自己的职业生涯有革命性的帮助，至少让我增长了见识，以及开拓了视野，希望来年有机会再次参与DTCC。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[一次业务设计失误，因唯一性索引导致的enq: TX – Row Lock Contention总结]]></title>
    <link href="http://RookieDBA.github.io/blog/2014/08/22/an-case-of-enq-tx-row-lock-contention/"/>
    <updated>2014-08-22T01:14:21+08:00</updated>
    <id>http://RookieDBA.github.io/blog/2014/08/22/an-case-of-enq-tx-row-lock-contention</id>
    <content type="html"><![CDATA[<p>年前，一个系统发布，刚上线就导致了大量的enq。之前一直没写下来，今天静下心记录一下。</p>

<p>业务上对某张表T进行insert操作，并且伴随着并发。T表中的HID字段因为业务需求有唯一性约束，所以这个字段上有唯一性约束并且有唯一索引。而HID的值需要通过一次额WS调用才能取得，为了提高系统吞吐量，减少响应时间，这里采取异步化的方式。然而业务设计上insert时先给HID字段初始0值，然后再update。由于有唯一性索引的关系，加上并发，导致大量session等待这个行级锁。</p>

<p>我们知道Oracle的索引会根据索引列的值进行排序，而对于唯一性索引来说，每个值在索引上只有一个位置可以写，所以大量的session等到0这个值的索引块的锁释放。</p>

<p>下面来重现一下这个场景：</p>

<p>1、建一张表T，字段HID建唯一性索引，并insert值为0的记录</p>

<figure class='code'><figcaption><span>1、建一张表T，字段HID建唯一性索引，并insert值为0的记录</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">yuqing</span><span class="o">@</span><span class="n">TOOLDB</span><span class="o">&gt;</span><span class="k">set</span> <span class="n">sqlp</span> <span class="s1">&#39;SESSION A&gt;&#39;</span>
</span><span class='line'><span class="k">SESSION</span> <span class="n">A</span><span class="o">&gt;</span><span class="k">create</span> <span class="k">table</span> <span class="n">t</span><span class="p">(</span><span class="n">hid</span> <span class="nb">number</span><span class="p">(</span><span class="mi">16</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="k">Table</span> <span class="n">created</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">SESSION</span> <span class="n">A</span><span class="o">&gt;</span><span class="k">create</span> <span class="k">unique</span> <span class="k">index</span> <span class="n">t_hid_ind</span> <span class="k">on</span> <span class="n">t</span><span class="p">(</span><span class="n">hid</span><span class="p">)</span> <span class="n">tablespace</span> <span class="n">zhifb_data</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">Index</span> <span class="n">created</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">SESSION</span> <span class="n">A</span><span class="o">&gt;</span><span class="k">insert</span> <span class="k">into</span> <span class="n">t</span> <span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span> <span class="k">row</span> <span class="n">created</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<!-- more -->


<p></p>

<p>2、然后在session B，也执行同样的insert</p>

<figure class='code'><figcaption><span>2、然后在session B，也执行同样的insert  </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">yuqing</span><span class="o">@</span><span class="n">TOOLDB</span><span class="o">&gt;</span><span class="k">set</span> <span class="n">sqlp</span> <span class="s1">&#39;SESSION B&gt;&#39;</span>
</span><span class='line'><span class="k">SESSION</span> <span class="n">B</span><span class="o">&gt;</span><span class="k">insert</span> <span class="k">into</span> <span class="n">t</span> <span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>
这时候发现，session B hang住了，它在等待session A的事务提交或者回滚</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">sys</span><span class="o">@</span><span class="n">TOOLDB</span><span class="o">&gt;</span><span class="k">select</span> <span class="n">USERNAME</span><span class="p">,</span><span class="n">EVENT</span><span class="p">,</span><span class="n">SQL_ID</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">session</span> <span class="k">where</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;YUQING&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">USERNAME</span>   <span class="n">EVENT</span>                                    <span class="n">SQL_ID</span>
</span><span class='line'><span class="c1">---------- ---------------------------------------- -------------</span>
</span><span class='line'><span class="n">YUQING</span>     <span class="k">SQL</span><span class="o">*</span><span class="n">Net</span> <span class="n">message</span> <span class="k">from</span> <span class="n">client</span>
</span><span class='line'><span class="n">YUQING</span>     <span class="n">enq</span><span class="p">:</span> <span class="n">TX</span> <span class="o">-</span> <span class="k">row</span> <span class="k">lock</span> <span class="n">contention</span>            <span class="mi">70</span><span class="n">nctf7574d1y</span>
</span><span class='line'>
</span><span class='line'><span class="n">sys</span><span class="o">@</span><span class="n">TOOLDB</span><span class="o">&gt;</span><span class="k">select</span> <span class="n">sql_id</span><span class="p">,</span><span class="n">sql_text</span> <span class="k">from</span> <span class="n">v</span><span class="err">$</span><span class="k">sql</span> <span class="k">where</span> <span class="n">sql_id</span><span class="o">=</span><span class="s1">&#39;70nctf7574d1y&#39;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">SQL_ID</span>        <span class="n">SQL_TEXT</span>
</span><span class='line'><span class="c1">------------- ----------------------------</span>
</span><span class='line'><span class="mi">70</span><span class="n">nctf7574d1y</span> <span class="k">insert</span> <span class="k">into</span> <span class="n">t</span> <span class="k">values</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>从上面的等待事件可以看出，这里的等待。</p>

<p>解决的方法：</p>

<p>1、业务改造，改为同步方式，接收到正确值以后再insert（牺牲吞吐量和响应时间）</p>

<p>2、最简单的方式，将0改为null</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SESSION</span> <span class="n">A</span><span class="o">&gt;</span><span class="k">insert</span> <span class="k">into</span> <span class="n">t</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span> <span class="k">row</span> <span class="n">created</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">SESSION</span> <span class="n">A</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">再另一个</span><span class="k">session</span><span class="err">中执行相同的</span><span class="k">insert</span>
</span><span class='line'>
</span><span class='line'><span class="k">SESSION</span> <span class="n">B</span><span class="o">&gt;</span><span class="k">insert</span> <span class="k">into</span> <span class="n">t</span> <span class="k">values</span><span class="p">(</span><span class="k">null</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="mi">1</span> <span class="k">row</span> <span class="n">created</span><span class="p">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">SESSION</span> <span class="n">B</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>从上面的实验可以看出，这里将0改为null后并没有产生等待，原因是，在Oracle中，null被定义成为一个不等于任何值的值，也即是说null不等于null，并且null并不会记录索引，唯一键并不需要非空，所以在不确定值的情况采用异步，初始一个null值能达到效果。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[备库创建datafile失败，MRP进程crash的处理]]></title>
    <link href="http://RookieDBA.github.io/blog/2014/08/22/standby-datafile-mrp-crash/"/>
    <updated>2014-08-22T00:23:08+08:00</updated>
    <id>http://RookieDBA.github.io/blog/2014/08/22/standby-datafile-mrp-crash</id>
    <content type="html"><![CDATA[<p>今天遇到一个问题，主库加数据文件后备库不久MRP进程crash。</p>

<p>看<code>alter</code>日志，发现如下错误：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>File #85 added to control file as &#39;UNNAMED00085&#39; because
</span><span class='line'>the parameter STANDBY_FILE_MANAGEMENT is set to MANUAL
</span><span class='line'>The file should be manually created to continue.
</span><span class='line'>Errors with log /data/arch/paycore2/paycore2_1_50043_794444625.arc
</span><span class='line'>MRP0: Background Media Recovery terminated with error 1274
</span><span class='line'>Errors in file /opt/oracle/paycore2/diag/rdbms/paycore2/paycore2/trace/paycore2_pr00_16671.trc:
</span><span class='line'>ORA-01274: cannot add datafile &#39;/data/oradata/paycore2/ESCROW_DATA_040.dbf&#39; - file could not be created
</span><span class='line'>Recovery interrupted!
</span><span class='line'>从alter日志上看，是备库的STANDBY_FILE_MANAGEMENT参数设置成了manual，所以主库创建数据文件备库不能自动添加。
</span></code></pre></td></tr></table></div></figure>


<p>
从DB上看</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>SQL&gt;select name,status from v$datafile order by 1;
</span><span class='line'>
</span><span class='line'>NAME                                                         STATUS
</span><span class='line'>----------------------------------------------------------- -------
</span><span class='line'>/data/oradata/paycore2/APPDATA1M_000.dbf                     ONLINE
</span><span class='line'>/data/oradata/paycore2/APPDATA1M_001.dbf                     ONLINE
</span><span class='line'>/data/oradata/paycore2/APPINDX1M_000.dbf                     ONLINE
</span><span class='line'>/data/oradata/paycore2/APPINDX1M_001.dbf                     ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_000.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_001.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_002.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_003.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_004.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_005.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_006.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_007.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_008.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_009.dbf                   ONLINE
</span><span class='line'>/data/oradata/paycore2/ESCROW_DATA_010.dbf                   ONLINE
</span><span class='line'>...
</span><span class='line'>/opt/oracle/paycore2/products/11.2.0/dbs/UNNAMED00085        RECOVER
</span><span class='line'>
</span><span class='line'>85 rows selected.
</span></code></pre></td></tr></table></div></figure>


<p></p>

<!--more-->


<p>处理的方式为：<br/>
1、备库重新创建数据文件</p>

<figure class='code'><figcaption><span>1、备库重新创建数据文件</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SQL</span><span class="o">&gt;</span><span class="k">alter</span> <span class="k">database</span> <span class="k">create</span> <span class="n">datafile</span> <span class="s1">&#39;/opt/oracle/paycore2/products/11.2.0/dbs/UNNAMED00085&#39;</span> <span class="k">as</span> <span class="s1">&#39;/data/oradata/paycore2/ESCROW_DATA_040.dbf&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p> <br/>
2、设置STANDBY_FILE_MANAGEMENT参数为auto</p>

<figure class='code'><figcaption><span>2、设置STANDBY_FILE_MANAGEMENT参数为auto</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SQL</span><span class="o">&gt;</span><span class="k">alter</span> <span class="k">system</span> <span class="k">set</span> <span class="n">STANDBY_FILE_MANAGEMENT</span><span class="o">=</span><span class="n">auto</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>
3、将备库恢复打开</p>

<figure class='code'><figcaption><span>3、将备库恢复打开</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SQL</span><span class="o">&gt;</span><span class="k">alter</span> <span class="k">database</span> <span class="n">recover</span> <span class="n">managed</span> <span class="n">standby</span> <span class="k">database</span> <span class="k">disconnect</span> <span class="k">from</span> <span class="k">session</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这么处理以后，后续的文件都陆续创建上来，不过唯独这个文件的status是recover状态，recover datafile 85;无效，后续再看看是什么原因，跟进一下。</p>

<p>–跟进
最后那个问题，是因为database的状态为<code>open</code>，只需将状态打到<code>mount</code>，再恢复就OK了</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Oracle 11.2.0.1 Active DataGuard的一个Bug]]></title>
    <link href="http://RookieDBA.github.io/blog/2014/08/22/oracle-11-dot-2-0-dot-1-active-dataguard-bug/"/>
    <updated>2014-08-22T00:13:49+08:00</updated>
    <id>http://RookieDBA.github.io/blog/2014/08/22/oracle-11-dot-2-0-dot-1-active-dataguard-bug</id>
    <content type="html"><![CDATA[<p>昨天在线下环境遇到一个Oracle的bug。现象为MRP进程中断，导致无法恢复恢复归档。<br/>
重新恢复应用归档，导致600错误，MRP进程中断</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">recover</span> <span class="n">managed</span> <span class="n">standby</span> <span class="k">database</span> <span class="k">using</span> <span class="k">current</span> <span class="n">logfile</span> <span class="k">disconnect</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>日志如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">Completed</span><span class="p">:</span> <span class="k">ALTER</span> <span class="k">DATABASE</span> <span class="n">RECOVER</span> <span class="n">managed</span> <span class="n">standby</span> <span class="k">database</span> <span class="k">using</span> <span class="k">current</span> <span class="n">logfile</span> <span class="k">disconnect</span>
</span><span class='line'><span class="n">Media</span> <span class="n">Recovery</span> <span class="n">Log</span> <span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">arch</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid_1_27059_794419612</span><span class="p">.</span><span class="n">arc</span>
</span><span class='line'><span class="n">Sat</span> <span class="nb">Dec</span> <span class="mi">22</span> <span class="mi">19</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">04</span> <span class="mi">2012</span>
</span><span class='line'><span class="n">Errors</span> <span class="k">in</span> <span class="n">file</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">mysid_pr0d_8142</span><span class="p">.</span><span class="n">trc</span> <span class="p">(</span><span class="n">incident</span><span class="o">=</span><span class="mi">626085</span><span class="p">):</span>
</span><span class='line'><span class="n">ORA</span><span class="o">-</span><span class="mi">00600</span><span class="p">:</span> <span class="n">internal</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">kcbr_apply_change_11</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class='line'><span class="n">Incident</span> <span class="n">details</span> <span class="k">in</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">incident</span><span class="o">/</span><span class="n">incdir_626085</span><span class="o">/</span><span class="n">mysid_pr0d_8142_i626085</span><span class="p">.</span><span class="n">trc</span>
</span><span class='line'><span class="n">Slave</span> <span class="n">exiting</span> <span class="k">with</span> <span class="n">ORA</span><span class="o">-</span><span class="mi">600</span> <span class="k">exception</span>
</span><span class='line'><span class="n">Errors</span> <span class="k">in</span> <span class="n">file</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">mysid_pr0d_8142</span><span class="p">.</span><span class="n">trc</span><span class="p">:</span>
</span><span class='line'><span class="n">ORA</span><span class="o">-</span><span class="mi">00600</span><span class="p">:</span> <span class="n">internal</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">kcbr_apply_change_11</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class='line'><span class="n">Errors</span> <span class="k">in</span> <span class="n">file</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">mysid_mrp0_8084</span><span class="p">.</span><span class="n">trc</span> <span class="p">(</span><span class="n">incident</span><span class="o">=</span><span class="mi">625909</span><span class="p">):</span>
</span><span class='line'><span class="n">ORA</span><span class="o">-</span><span class="mi">00600</span><span class="p">:</span> <span class="n">internal</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">kcbr_apply_change_11</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class='line'><span class="n">Incident</span> <span class="n">details</span> <span class="k">in</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">incident</span><span class="o">/</span><span class="n">incdir_625909</span><span class="o">/</span><span class="n">mysid_mrp0_8084_i625909</span><span class="p">.</span><span class="n">trc</span>
</span><span class='line'><span class="n">Sat</span> <span class="nb">Dec</span> <span class="mi">22</span> <span class="mi">19</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">05</span> <span class="mi">2012</span>
</span><span class='line'><span class="n">Trace</span> <span class="n">dumping</span> <span class="k">is</span> <span class="n">performing</span> <span class="n">id</span><span class="o">=</span><span class="p">[</span><span class="n">cdmp_20121222190505</span><span class="p">]</span>
</span><span class='line'><span class="n">Recovery</span> <span class="n">Slave</span> <span class="n">PR0D</span> <span class="n">previously</span> <span class="n">exited</span> <span class="k">with</span> <span class="k">exception</span> <span class="mi">600</span>
</span><span class='line'><span class="n">MRP0</span><span class="p">:</span> <span class="n">Background</span> <span class="n">Media</span> <span class="n">Recovery</span> <span class="n">terminated</span> <span class="k">with</span> <span class="n">error</span> <span class="mi">448</span>
</span><span class='line'><span class="n">Errors</span> <span class="k">in</span> <span class="n">file</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">mysid_pr00_8089</span><span class="p">.</span><span class="n">trc</span><span class="p">:</span>
</span><span class='line'><span class="n">ORA</span><span class="o">-</span><span class="mi">00448</span><span class="p">:</span> <span class="n">normal</span> <span class="k">completion</span> <span class="k">of</span> <span class="n">background</span> <span class="n">process</span>
</span><span class='line'><span class="n">Managed</span> <span class="n">Standby</span> <span class="n">Recovery</span> <span class="k">not</span> <span class="k">using</span> <span class="nb">Real</span> <span class="n">Time</span> <span class="n">Apply</span>
</span><span class='line'><span class="n">Recovery</span> <span class="n">interrupted</span><span class="o">!</span>
</span><span class='line'><span class="n">Sat</span> <span class="nb">Dec</span> <span class="mi">22</span> <span class="mi">19</span><span class="p">:</span><span class="mi">05</span><span class="p">:</span><span class="mi">07</span> <span class="mi">2012</span>
</span><span class='line'><span class="n">Sweep</span> <span class="p">[</span><span class="n">inc</span><span class="p">][</span><span class="mi">626085</span><span class="p">]:</span> <span class="n">completed</span>
</span><span class='line'><span class="n">Sweep</span> <span class="p">[</span><span class="n">inc</span><span class="p">][</span><span class="mi">625909</span><span class="p">]:</span> <span class="n">completed</span>
</span><span class='line'><span class="n">Sweep</span> <span class="p">[</span><span class="n">inc2</span><span class="p">][</span><span class="mi">626085</span><span class="p">]:</span> <span class="n">completed</span>
</span><span class='line'><span class="n">Sweep</span> <span class="p">[</span><span class="n">inc2</span><span class="p">][</span><span class="mi">625909</span><span class="p">]:</span> <span class="n">completed</span>
</span><span class='line'><span class="n">Recovered</span> <span class="k">data</span> <span class="n">files</span> <span class="k">to</span> <span class="n">a</span> <span class="n">consistent</span> <span class="k">state</span> <span class="k">at</span> <span class="n">change</span> <span class="mi">9887019691275</span>
</span><span class='line'><span class="n">Errors</span> <span class="k">in</span> <span class="n">file</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">mysid_pr00_8089</span><span class="p">.</span><span class="n">trc</span><span class="p">:</span>
</span><span class='line'><span class="n">ORA</span><span class="o">-</span><span class="mi">00448</span><span class="p">:</span> <span class="n">normal</span> <span class="k">completion</span> <span class="k">of</span> <span class="n">background</span> <span class="n">process</span>
</span><span class='line'><span class="n">Errors</span> <span class="k">in</span> <span class="n">file</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">oracle</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">diag</span><span class="o">/</span><span class="n">rdbms</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">mysid</span><span class="o">/</span><span class="n">trace</span><span class="o">/</span><span class="n">mysid_mrp0_8084</span><span class="p">.</span><span class="n">trc</span><span class="p">:</span>
</span><span class='line'><span class="n">ORA</span><span class="o">-</span><span class="mi">00600</span><span class="p">:</span> <span class="n">internal</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="p">[</span><span class="n">kcbr_apply_change_11</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
</span><span class='line'><span class="n">MRP0</span><span class="p">:</span> <span class="n">Background</span> <span class="n">Media</span> <span class="n">Recovery</span> <span class="n">process</span> <span class="n">shutdown</span> <span class="p">(</span><span class="n">mysid</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<!--more-->


<p>根据关键字<code>kcbr_apply_change_11</code>查找<code>metalink</code>，发现这是一个Oracle的bug。</p>

<figure class='code'><figcaption><span>Bug 10419984 – Active data guard standby gets ORA-600 [kcbr_apply_change_11] [ID 10419984.8]</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='text'><span class='line'>Bug 10419984 – Active data guard standby gets ORA-600 [kcbr_apply_change_11] [ID 10419984.8]
</span><span class='line'>
</span><span class='line'>Rediscovery Notes:
</span><span class='line'>Look for all the following:
</span><span class='line'>- ADG media recovery fails with ORA-00600:[kcbr_apply_change_11]
</span><span class='line'>- primary/ADGstandby configuration
</span><span class='line'>- there has been at least one primary&lt;-&gt;standby switchover(the evidence is an earlier “SWITCHOVER TO PHYSICAL
</span><span class='line'>STANDBY” message in the standby alert log)
</span><span class='line'>- in the incident dump tracefile:
</span><span class='line'>- the failing redo change vector header is dumped, and the opcode is 18.1 (OP:18.1)
</span><span class='line'>- in 11.2 look for “Block SCN:” and “Redo SCN:” in 11.1 look for “Redo scn:”
</span><span class='line'>the scns involved will have the following ordering:
</span><span class='line'>cv.SCN &lt; Block_SCN &lt; Redo_SCN
</span><span class='line'>- the block header is dumped and it shows the standby’s version of the block has an ITL entry with:
</span><span class='line'>Flag=U, Lck!=0, Scn/Fsc=&lt;0×0000.Block_SCN.base#&gt;
</span><span class='line'>- if you take the Block_SCN, and if you can map it to a date+time, (eg by using time/scn
</span><span class='line'>data from v$archived_log,or from media recovery messsages in the alert log) then
</span><span class='line'>you should see the standby was running as the primary database at that time/Block_SCN.
</span><span class='line'>- alert logs have the message “Lost write protection disabled” written at database mount time
</span><span class='line'>- after the failure, the ADG media recovery fails the same way even if it is restarted,
</span><span class='line'>but regular media recovery (ie without the database open read-only) is able to apply the failing redo
</span><span class='line'>
</span><span class='line'>Workaround
</span><span class='line'>
</span><span class='line'>After the problem has happened:
</span><span class='line'>shutdown the ADG standby, then mount it, and do media recovery until it has recovered
</span><span class='line'>past all the redo generated during the hot backup taken on the primary. Then stop media
</span><span class='line'>recovery, and open the database read only, and restart media recovery again.
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>根据<code>metalink</code>上的描述，将ADG的物理备库shutdown，然后startup到mount状态，恢复之前的归档之后，open database，再恢复就OK了。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Expdp/impdp]]></title>
    <link href="http://RookieDBA.github.io/blog/2014/08/21/expdp-slash-impdp/"/>
    <updated>2014-08-21T22:29:20+08:00</updated>
    <id>http://RookieDBA.github.io/blog/2014/08/21/expdp-slash-impdp</id>
    <content type="html"><![CDATA[<p>今天用expdp和impdp做数据迁移，针对整个schema的数据导入导出，也很有幸体验到了exp和expdp在速度上的差别，因为exp要过一层buffer，所以速度上慢特别多，一个67G数据的schema，用expdp大概花了半个小时，而exp半个小时大概生成3G左右的数据，速度上还是相差很大的。</p>

<hr />

<h1>EXPDP</h1>

<p>用expdp之前要在oracle中创建一个directory。</p>

<figure class='code'><figcaption><span>directory</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">conn</span> <span class="o">/</span> <span class="k">as</span> <span class="n">sysdba</span>
</span><span class='line'><span class="k">create</span> <span class="k">or</span> <span class="k">replace</span> <span class="n">directory</span> <span class="n">dir_name</span> <span class="k">as</span> <span class="err">‘</span><span class="o">/</span><span class="n">path</span><span class="err">’</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后到os中，用expdp命令导出数据</p>

<figure class='code'><figcaption><span>expdp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">expdp</span> <span class="k">system</span><span class="o">/</span><span class="n">password</span> <span class="n">schemas</span><span class="o">=</span><span class="k">schema_name</span> <span class="n">directory</span><span class="o">=</span><span class="n">dump</span> <span class="n">dumpfile</span><span class="o">=</span><span class="n">out_file_name</span><span class="p">.</span><span class="n">dmp</span> <span class="n">logfile</span><span class="o">=</span><span class="n">log_file_name</span><span class="p">.</span><span class="n">log</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>则会在dump目录下生成dmp文件和log文件，这里的directory就是之前在Oracle中创建的directory。</p>

<hr />

<h1>IMPDP</h1>

<p>用impdp来导入数据和前面一样，dmp文件就是之前expdp出来的dmp文件。</p>

<figure class='code'><figcaption><span>impdp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">impdp</span> <span class="k">system</span><span class="o">/</span><span class="n">password</span> <span class="n">schemas</span><span class="o">=</span><span class="k">schema_name</span> <span class="n">directory</span><span class="o">=</span><span class="n">dump</span> <span class="n">dumpfile</span><span class="o">=</span><span class="n">imp_file</span><span class="p">.</span><span class="n">dmp</span> <span class="n">logfile</span><span class="o">=</span><span class="n">log_imp</span><span class="p">.</span><span class="n">log</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>impdp似乎可以直接和expdp连接使用，就可以边导出边导入了，有待研究。</p>

<hr />

<!--more-->


<h1>关于NETWORK_LINK参数</h1>

<p>如果有指定NETWORK_LINK参数，则可以远程传输至目标端，network_link的值为dblink的名字。<br/>
首先，在目标端库建立一个dblink至源端。<br/>
expdp指定network_link参数将可以直接在目标端生成dump文件。<br/>
impdp指定network_link参数，可以直接绕过生成dump文件，直接从源端导出并导入目标端。<br/>
相应的EXP和IMP就简单一点（buffer设大一点快，exp不小于64000，imp不小于100000）</p>

<figure class='code'><figcaption><span>exp/imp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">exp</span> <span class="k">schema_name</span><span class="o">/</span><span class="n">password</span>  <span class="n">BUFFER</span><span class="o">=</span><span class="mi">1000000000</span> <span class="n">FILE</span><span class="o">=/</span><span class="k">data</span><span class="o">/</span><span class="n">oradata</span><span class="o">/</span><span class="n">dump</span><span class="o">/</span><span class="n">out_file_name</span><span class="p">.</span><span class="n">dmp</span> <span class="k">OWNER</span><span class="o">=</span><span class="k">schema_name</span> <span class="n">log</span><span class="o">=</span><span class="n">logfile</span><span class="p">.</span><span class="n">log</span>
</span><span class='line'><span class="n">imp</span> <span class="k">schema_name</span><span class="o">/</span><span class="n">password</span>  <span class="n">BUFFER</span><span class="o">=</span><span class="mi">1000000000</span> <span class="n">FILE</span><span class="o">=/</span><span class="k">data</span><span class="o">/</span><span class="n">oradata</span><span class="o">/</span><span class="n">dump</span><span class="o">/</span><span class="n">imp_file_name</span><span class="p">.</span><span class="n">dmp</span>  <span class="n">FROMUSER</span><span class="o">=</span><span class="n">from_schema</span> <span class="n">TOUSER</span><span class="o">=</span><span class="k">schema_name</span> <span class="n">log</span><span class="o">=</span><span class="n">logfile</span><span class="p">.</span><span class="n">log</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
